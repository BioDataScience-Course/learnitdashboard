#' right_sidebar UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd 
#'
#' @importFrom shiny NS tagList 
mod_right_sidebar_ui <- function(id){
  ns <- NS(id)
  tagList(
    column( width = 12,
      # Selector of course :
      tags$h3("Course :"),
      tags$br(),
      # Selector of table :
      uiOutput(ns("ui_table_selector")),
      # Selector of app :
      uiOutput(ns("ui_app_selector")),
      # Selector of login :
      uiOutput(ns("ui_login_selector")),
      # Selectors of time range :
      tags$h3("Time :"),
      checkboxInput(ns("is_dates"), h4("Select dates", style = "margin : 0px;")),
      uiOutput(ns("ui_dates_selectors"))
    )
  )
}
    
#' right_sidebar Server Functions
#'
#' @noRd 
mod_right_sidebar_server <- function(id, all_vars){
  moduleServer( id, function(input, output, session){
    ns <- session$ns

# Global Vars / Connecting to DB ------------------------------------------

    # URL to access databases
    sdd_url <- "mongodb://127.0.0.1:27017/sdd"
    # To connect to them
    sdd_h5p <- try(mongolite::mongo("h5p", url = sdd_url), silent = TRUE)
    sdd_learnr <- try(mongolite::mongo("learnr", url = sdd_url), silent = TRUE)
    sdd_shiny <- try(mongolite::mongo("shiny", url = sdd_url), silent = TRUE)
    
    # === H5P Variables ===
    # Variable : H5P
    h5p <- reactiveVal()
    
    # === Learnr Variables ===
    # Variable : Learnr
    learnr <- reactiveVal()
    
    # === Shiny Variables ===
    # Variable : Shiny
    shiny <- reactiveVal()
    
    # === SDD Variables ===
    # Variable : Users
    sdd_users <- try(mongolite::mongo("users", url = sdd_url), silent = TRUE)
    
    # Variable : Logins
    # logins <- try(sort(sdd_users$distinct("user_login")), silent = TRUE)
    logins <- try(sort(unique(c(sdd_users$distinct("user_login"), sdd_h5p$distinct("login")))), silent = TRUE)
    
    # Disconnecting from users table
    try(sdd_users$disconnect(), silent = TRUE)
    
    # If logins occurred an error, it becomes NULL
    if (inherits(logins, "try-error") || length(logins) == 0) {
      logins <- NULL
    }

# Display Selectors ---------------------------------------------------------------

    # Display // Table selector
    output$ui_table_selector <- renderUI({
      tagList(
        tags$h3("Table :"),
        selectInput(ns("selected_table"), NULL, choices = c("H5P", "Learnr", "Shiny"), selected = "H5P")
      )
    })
    
    # Display // App selector
    output$ui_app_selector <- renderUI({
      req(input$selected_table)
      
      # Getting the right table
      table <- switch (input$selected_table,
                       "H5P" = sdd_h5p,
                       "Learnr" = sdd_learnr,
                       "Shiny" = sdd_shiny
      )
      
      # Getting table's apps
      table_apps <- try(sort(table$distinct("app")), silent = TRUE)
      
      # Displaying the selector if table_apps didn't occur error
      if (!inherits(table_apps, "try-error")) {
        tagList(
          tags$h3("Application :"),
          selectInput(ns("sdd_selected_app"), NULL, choices = c("All", table_apps), selected = "All")
        )
      }
    })
    
    # Display // Login selector
    output$ui_login_selector <- renderUI({
      # If there was no error while getting the logins
      if (!is.null(logins)) {
        tagList(
          tags$h3("Login :"),
          # Creation of selector with choices "All" and the logins
          selectInput(ns("sdd_selected_login"), NULL, choices = c("All", logins))
        )
      } else { NULL }
    })
    
    # Display // Dates selectors
    output$ui_dates_selectors <- renderUI({
      if (input$is_dates == TRUE) {
        tagList(
          # First selector of date
          tags$h4("From :"),
          dateInput(ns("sdd_selected_date1"), NULL, value = input$sdd_selected_date1),
          # First selector of time
          timeInput(ns("sdd_selected_time1"), NULL, value = input$sdd_selected_time1, seconds = FALSE),
          # Second selector of date
          tags$h4("To :"),
          dateInput(ns("sdd_selected_date2"), NULL, value = input$sdd_selected_date2),
          # Second selector of time
          timeInput(ns("sdd_selected_time2"), NULL, value = input$sdd_selected_time2, seconds = FALSE),
        )
      } else {
        # To create the inputs but without making them available to user (for reactivity)
        tagList(
          shinyjs::hidden(dateInput(ns("sdd_selected_date1"), NULL, value = input$sdd_selected_date1)),
          shinyjs::hidden(timeInput(ns("sdd_selected_time1"), NULL, value = input$sdd_selected_time1)),
          shinyjs::hidden(dateInput(ns("sdd_selected_date2"), NULL, value = input$sdd_selected_date2)),
          shinyjs::hidden(timeInput(ns("sdd_selected_time2"), NULL, value = input$sdd_selected_time2)),
        )
      }
    })
    
# Request ---------------------------------------------------------
    
    # Variable : Request
    request <- reactiveVal()
    
    # Variable : Definition of the request depending on login, app and dates/times
    observeEvent({
      print(input$sdd_selected_login)
      print(input$sdd_selected_app)
      print(input$is_dates)
      print(input$sdd_selected_date1)
      print(input$sdd_selected_date2)
      input$sdd_selected_time1
      input$sdd_selected_time2
    }, {
      # Is there a login request ?
      login_request <- !is.null(input$sdd_selected_login) && input$sdd_selected_login != "All"
      # Creation of the request part for login
      if (login_request) {
        login_query <- glue::glue(r"("login" : "<<input$sdd_selected_login>>")", .open = "<<", .close = ">>")
      }
      # Is there an app request ?
      app_request <- !is.null(input$sdd_selected_app) && input$sdd_selected_app != "All"
      # Creation of the request part for app
      if (app_request) {
        app_query <- glue::glue(r"("app" : "<<input$sdd_selected_app>>")", .open = "<<", .close = ">>")
      }
      # Is there a date request ?
      date_request <- input$is_dates == TRUE
      # Creation of the request part for dates
      if (date_request) {
        date_query <- glue::glue(r"("date" : { "$gte" : "<<paste0(input$sdd_selected_date1, " ", strftime(input$sdd_selected_time1, "%H:%M"))>>" , "$lte" : "<<paste0(input$sdd_selected_date2, " ", strftime(input$sdd_selected_time2, "%H:%M"))>>" })", .open = "<<", .close = ">>")
        print(date_query)
      }
      
      # Definition of the request
      # Request of login and app
      if (login_request && app_request) {
        if (date_request) {
          build_request <- r"({<<login_query>> , <<app_query>> , <<date_query>>})"
        } else {
          build_request <- r"({<<login_query>> , <<app_query>>})"
        }
        # Request of login
      } else if (login_request) {
        if (date_request) {
          build_request <- r"({<<login_query>> , <<date_query>>})"
        } else {
          build_request <- r"--[{<<login_query>>}]--"
        }
        # Request of app
      } else if (app_request) {
        if (date_request) {
          build_request <- r"({<<app_query>> , <<date_query>>})"
        } else {
          build_request <- r"({<<app_query>>})"
        }
        # No special request
      } else if (date_request) {
        build_request <- r"({<<date_query>>})"
      } else {
        build_request <- "{}"
      }
      # Send the request after evaluating it
      request(glue::glue(build_request, .open = "<<", .close = ">>"))
      print(paste0(request(), "creation"))
    })
    
    # Defining tables depending on the request
    observeEvent(request(), {
      print(request())
      {message("requete h5p");h5p(try(sdd_h5p$find(request(), limit = 1000), silent = TRUE))}
      {message("requete learnr");learnr(try(sdd_learnr$find(request(), limit = 1000), silent = TRUE))}
      {message("requete shiny");shiny(try(sdd_shiny$find(request(), limit = 1000), silent = TRUE))}
    })
    

# Communication -----------------------------------------------------------

    # Variable : all of module's vars
    right_sidebar_vars <- reactiveValues(
      selected_table = NULL,
      h5p = NULL,
      learnr = NULL,
      shiny = NULL,
    )
    
    # Updating the vars
    observe({
      right_sidebar_vars$selected_table <- input$selected_table
    })
    observe({
      right_sidebar_vars$h5p <- h5p()
      right_sidebar_vars$learnr <- learnr()
      right_sidebar_vars$shiny <- shiny()
    })
    
    return(right_sidebar_vars)
    
  })
}
    
## To be copied in the UI
# mod_right_sidebar_ui("right_sidebar_1")
    
## To be copied in the server
# mod_right_sidebar_server("right_sidebar_1")
